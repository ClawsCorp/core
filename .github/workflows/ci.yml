name: CI

on:
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend:
    name: backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install backend dependencies
        run: python -m pip install -r backend/requirements.txt
      - name: Run backend tests (allow no tests)
        run: |
          set +e
          python -m pytest
          code=$?
          if [ "$code" = "5" ]; then
            echo "No tests collected yet; skipping."
            exit 0
          fi
          exit "$code"
        working-directory: backend

  frontend:
    name: frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Frontend placeholder
        run: |
          echo "Frontend checks are defined in Prompt #2.1 outputs."
          echo "No frontend checks configured yet."

  contracts:
    name: contracts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Detect Hardhat project
        id: hardhat-check
        run: |
          if [ -f contracts/package.json ] && { [ -f contracts/hardhat.config.js ] || [ -f contracts/hardhat.config.ts ]; }; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Skip contracts checks
        if: steps.hardhat-check.outputs.should_run != 'true'
        run: echo "No Hardhat project detected (missing contracts/package.json or hardhat.config.*). Skipping."
      - name: Install contracts dependencies
        if: steps.hardhat-check.outputs.should_run == 'true'
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
        working-directory: contracts
      - name: Compile contracts
        if: steps.hardhat-check.outputs.should_run == 'true'
        run: npx hardhat compile
        working-directory: contracts
      - name: Test contracts (if tests exist)
        if: steps.hardhat-check.outputs.should_run == 'true'
        run: |
          if [ -d test ] || [ -d tests ]; then
            npx hardhat test
          else
            echo "No contracts tests directory found; skipping."
          fi
        working-directory: contracts
