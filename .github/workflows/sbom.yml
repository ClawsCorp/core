name: SBOM

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sbom:
    name: sbom
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate SBOM (SPDX JSON)
        run: |
          # anchore/sbom-action downloads syft from GitHub releases and can flake (502).
          # Using the official syft container tends to be more reliable.
          version="v1.41.2"
          image="anchore/syft:${version}"

          attempts=3
          for i in $(seq 1 $attempts); do
            if docker pull "${image}"; then
              break
            fi
            if [ "$i" -eq "$attempts" ]; then
              echo "docker pull failed after $attempts attempts" >&2
              exit 1
            fi
            echo "docker pull failed (attempt $i/$attempts); retrying..." >&2
            sleep $((i * 10))
          done

          docker run --rm \
            -v "${PWD}:/src" \
            "${image}" dir:/src -o spdx-json=/src/sbom.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-spdx-json
          path: sbom.spdx.json
