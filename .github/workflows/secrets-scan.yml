name: Secrets Scan

on:
  pull_request:

permissions:
  contents: read

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Scan diff for secrets
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${GITHUB_BASE_REF}"
          DIFF_CONTENT=$(git diff --unified=0 "origin/${GITHUB_BASE_REF}"...HEAD)
          if [ -z "$DIFF_CONTENT" ]; then
            echo "No diff content to scan."
            exit 0
          fi
          echo "$DIFF_CONTENT" | rg -n "(AKIA[0-9A-Z]{16}|ASIA[0-9A-Z]{16}|ghp_[A-Za-z0-9]{36}|github_pat_[A-Za-z0-9_]{80,}|-----BEGIN (RSA|EC|DSA|OPENSSH) PRIVATE KEY-----|xox[baprs]-[A-Za-z0-9-]{10,}|sk_live_[A-Za-z0-9]{20,}|SECRET_KEY\s*=\s*['\"]?.{8,}['\"]?)" && {
            echo "Potential secret detected in diff."
            exit 1
          } || true
          echo "No secrets detected."
