name: Secrets Scan

on:
  pull_request:

permissions:
  contents: read
  pull-requests: read

jobs:
  secrets-scan:
    name: secrets-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch base branch
        run: git fetch origin "${{ github.base_ref }}" --depth=1
      - name: Scan diff for secrets
        run: |
          python - <<'PY'
          import os
          import re
          import subprocess
          import sys

          base_ref = os.environ.get("GITHUB_BASE_REF")
          diff = subprocess.check_output(
              [
                  "git",
                  "diff",
                  "--no-color",
                  "--unified=0",
                  f"origin/{base_ref}...HEAD",
              ],
              text=True,
              errors="replace",
          )

          patterns = [
              ("AWS Access Key ID", re.compile(r"\b(AKIA|ASIA)[0-9A-Z]{16}\b")),
              (
                  "AWS Secret Access Key",
                  re.compile(
                      r"\baws_secret_access_key\b\s*[:=]\s*['\"]?[A-Za-z0-9/+=]{40}['\"]?",
                      re.IGNORECASE,
                  ),
              ),
              (
                  "Private Key Header",
                  re.compile(r"BEGIN (RSA|DSA|EC|OPENSSH|PGP)? ?PRIVATE KEY"),
              ),
              (
                  "GitHub Token",
                  re.compile(r"\b(ghp_[A-Za-z0-9]{36,}|github_pat_[A-Za-z0-9_]{20,})\b"),
              ),
              ("Slack Token", re.compile(r"\bxox[baprs]-[A-Za-z0-9-]{10,}\b")),
              ("Google API Key", re.compile(r"\bAIza[0-9A-Za-z\-_]{35}\b")),
              ("Stripe Live Secret", re.compile(r"\bsk_live_[0-9a-zA-Z]{24,}\b")),
              (
                  "JWT",
                  re.compile(
                      r"\beyJ[a-zA-Z0-9_-]{10,}\.[a-zA-Z0-9_-]{10,}\.[a-zA-Z0-9_-]{10,}\b"
                  ),
              ),
          ]

          findings = []
          current_file = None
          new_line_num = None

          for line in diff.splitlines():
              if line.startswith("+++ b/"):
                  current_file = line[6:]
                  continue
              if line.startswith("@@"):
                  match = re.match(r"@@ -\d+(?:,\d+)? \+(\d+)(?:,\d+)? @@", line)
                  if match:
                      new_line_num = int(match.group(1))
                  continue
              if line.startswith("+") and not line.startswith("+++"):
                  content = line[1:]
                  if current_file and new_line_num is not None:
                      for name, pattern in patterns:
                          if pattern.search(content):
                              findings.append((current_file, new_line_num, name))
                  if new_line_num is not None:
                      new_line_num += 1
                  continue
              if line.startswith("-") and not line.startswith("---"):
                  continue
              if line.startswith(" ") and new_line_num is not None:
                  new_line_num += 1

          if findings:
              print("Potential secrets detected in pull request diff:")
              for path, line_number, name in findings:
                  print(f"- {name} in {path}:{line_number}")
              sys.exit(1)

          print("No secrets detected in pull request diff.")
          PY
